<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Congressional Career Paths</title>
        <link rel="stylesheet" href="css/styles.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js">
        </script>
    </head>

    <body>
        <button id="theme-toggle" aria-label="Toggle dark mode">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="12" fill="color"/>
            </svg>
        </button>

        <div id="side-panel">
            <div class="search-container">
                <input type="text" class="search-input"
                    placeholder="Search congresspeople by name...">
                <select id="congress-select" class="congress-select"></select>
                <div class="dropdown"></div>
            </div>
            <div id="writeup">

<h1>Paths to Congress</h1>
<h2>by Henry Josephson</h2>
<br>
<hr>
<br>
On the right half of this page are the things congresspeople did before Congress.
<br><br>
Each line represents a 
<span style="color: #268AB9;">―</span> Democratic or 
<span style="color: #FF3C51;">―</span> Republican congressperson, and
<span style="display: inline-block; width: 16px; height: 16px; border: 1px solid var(--text-color); border-radius: 50%; vertical-align: middle;"></span>
circles are the major milestones on their path to the Capitol. 
<br><br>
You can mouse over paths to learn who they belong to, and you can also search
congresspeople by name, state, and district in the box at the top left. The
dropdown should let you choose any congress since 1987.
<br><br>
<i>Note that paths are not exhaustive, nor are they in chronological order.</i>
<br>
<br>
<hr>
<br>
Dread it, run from it: every two years, a new election arrives. And with every
new election comes a new crop of congresspeople, giving the people a chance
to choose new lawmakers to represent them in Washington.
<br><br>
How, though, do they get to the Capitol?
<br><br>
The <i>New York Times</i> built a 
<a href="https://www.nytimes.com/interactive/2019/01/26/opinion/sunday/paths-to-congress.html">
    beautiful visualization
</a> when they investigated this back in 2019 (shoutout Sahil Chinoy and 
Jessia Ma!), but their analysis is long-outdated and was a pain to replicate —
it's entirely closed-source! They also restricted themselves to the then-current
116th Congress. What about the 117 (soon to be 118!) others?
<br><br>
Here, I set out to answer this question — what did the people who are currently
in congress do before they got there?
<br><br>
<h3>Undergrad</h3>
For starters, most of them went to college!
<div class="highlight-box" 
        data-highlight-condition="politician.stages.includes('noBA')"
        data-highlight-description="highlight no undergrad">
    Mouse over to highlight all congresspeople without a bachelor's degree
</div>
<br>
This has changed since the NYT's original investigation in 2019 — back then,
About 5 percent of representatives don't have a bachelor's degree, compared
with about two-thirds of Americans 25 and older. Since then, though, the fraction
of Americans with less than a bachelor's has <a href="https://www.census.gov/newsroom/press-releases/2023/educational-attainment-data.html">
    slightly (though not significantly) increased
</a> to around 38%, and the fraction of congresspeople without an undergraduate
degree has increased by a factor of around 1.5x, from around 6% of the legislature
to around 13%. Overall, though, this is a marked increase from the 100th Congress
in the late 1980s, when only ~1% of the legislature got there without a BA!
<br><br>
Notably, only one person without a BA
(<a href="https://en.wikipedia.org/wiki/Markwayne_Mullin">Markwayne Mullin of
    Oklahoma</a>) currently serves in the Senate.
<br><br>
It's also notable just how many congresspeople went to elite colleges (defined
as MIT, Stanford, the Ivies, Duke, and — best for last — the University of Chicago):
<div class="highlight-box" 
        data-highlight-condition="politician.stages.includes('eliteCollege')"
        data-highlight-description="highlight elite college">
    Mouse over to highlight all congresspeople who went to elite colleges
</div>
These few schools, which have single-digit acceptance rates and are about as
elite as you can get, have pretty consistently represented around 16% of congress
since the 80s — around 10% in the House and around 20% in the senate.
<br><br>
Interestingly, Yale had 20 legislators in the 100th Congress 40 years ago, but
only 7 in the 116th and only 8 in the 118th. I wonder why they lost a step?
<br><br>
The partisan lean of the elites has also changed over time — look at how the blue
and red paths change in the "Elite college" circle as you change the congress.
While 55% of elite college graduates in congress were Democrats in the 100th
Congress, 68% were Democrats in the 116th, when the NYT did their analysis. Today,
five years later, that number is up to 71%.
<br><br>
<h3>Grad School</h3>
<div class="highlight-box" 
        data-highlight-condition="
        politician.stages.includes('lawSchool') ||
        politician.stages.includes('medDegree') ||
        politician.stages.includes('mba') ||
        politician.stages.includes('doctorate') ||
        politician.stages.includes('otherMasters')
        "
        data-highlight-description="highlight grad degrees">
    Mouse over to highlight all congresspeople with a graduate degree
</div>
The fraction of congress with a graduate degree has stayed consistent, at around
two thirds. This is more than 4x the fraction of Americans that had a grad degree
in 2022! Most interestingly, though, the number of congresspeople with law degrees
is disproportionate but decreasing — down from 50% of congress in the '80s to ~40%
in 2019 to ~33% today.
<br><br>
(Check this by changing the dropdown in the top left!)
<br><br>
A former president of the NY State Bar Association <a href="https://archive.is/X3lnO">
    wrote this year
</a> about a similar trend in New York state. There, he notes two main obstacles:
<br><br>
First, pay. Today, <a href="https://www.ntu.org/foundation/tax-page/salaries-for-members-of-congress-supreme-court-justices-and-the-president">
congresspeople make $174,000 per year</a>. This is a good deal of money, but lawyer salaries — <a href="https://www.biglawinvestor.com/bimodal-salary-distribution-curve/">
    bimodal
</a> though they may be at the start — don't seem to be sufficiently higher to
warrant the public scrutiny and move to DC.
<br><br>
Second, it seems to be tough to keep up a private practice while also serving
in office. Ethics laws, combined with the fact that being a congressperson is
itself a full-time job — mean that lawyers can't have their cake and eat it, too.
This doesn't mean no lawyers will give up their private practices (just look at
the <b>lawyer (private practice)</b> node!), but it means that fewer will.
<br><br>
Before leaving the lawyer section, I'll link to an interesting <a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=2898140">econ paper</a> 
arguing that most of the reason lawyers are so well-represented in congress isn't
just because they run more — "Conditional on running, lawyers win at twice the
rate of candidates from other backgrounds. Contrary to prevailing theories in
the literature, voters do not reward candidates with backgrounds in law.
Rather, lawyers win because of a sizable competitive advantage in early
fundraising, owing in large part to their professional networks." No commentary
here — just interesting!
<br><br>
<h3>Military Experience</h3>
<br>
The change in the fraction of congresspeople with military experience is one
of the biggest changes I've noticed in this data. You don't even have to mouse
over the box to notice the difference (but you should, it took me work to make!).
Just look at how big the <i>military</i> node is in the 118th Congress, then
flip back to the '80s — huge difference!

<div class="highlight-box" 
        data-highlight-condition="politician.stages.includes('military')"
        data-highlight-description="highlight military">
    Mouse over to highlight all congresspeople who served in the military
</div>

It used to be the case that more than half of congress had served, and that the
senate was significantly more militarized than the House -- in the 100th congress,
around 53% of the house had served and a whopping 72% of the senate had!
<br>
<br>
The reason is probably World War Two. After all, if you
were 20 years old in the 1940s, you'd be in your late sixties/early 70s by the 
time the 100th congress came around — prime legislatin' age. People who'd fought 
in Korea in the '50s and Vietnam in the '60s would also be around electable age.
<br>
<br>
Fortunately, since we haven't had mobilization on that scale since the '60s, it's
no longer the case that most Americans have military experience, which means it
makes a little more sense that most of congress doesn't either. The proportion
of congresspeople with military experience has stayed around 20% since
the Obama years.
<br>
<br>
It's important to be clear that veterans are seriously overrepresented in congress,
though. Even with representation at a 40-year low in the 118th congress ("only"
18% of which are veterans), this is triple the fraction of the U.S. as a whole
that have served (per <a href="https://www.pewresearch.org/short-reads/2023/11/08/the-changing-face-of-americas-veteran-population/">Pew Research in 2023</a>,
that's around 6%).
<br>
<br>
Interestingly, with this decline, congresspeople who have served have gotten
more partisan — in the 100th congress, 54% of veterans were Democrats. 20 years
later, only 32% of veterans were Democrats. And by 2022? A mere 27%. I'm not
sure what to attribute this to — did the parties change views? Did military
folks get more conservative? My hunch is that it has something to do with 
the fact that the US military has been all-volunteer since the '70s. It'd take
a while for this to propogate down to the people who're getting elected to
congress, but it seems <i>prima facie</i> right to me that more conservative
people would be more likely to volunteer than more liberal people.
<br>
<br>
<h3>Business</h3>
<br>
The other huge trend I couldn't help but notice from the '80s to today was the
increase in congresspeople claiming business experience:
<br><br>
<div class="highlight-box" 
        data-highlight-condition="politician.stages.includes('businessOrManagement')"
        data-highlight-description="highlight military">
    Mouse over to highlight all congresspeople who claim business experience
</div>
<br><br>
We went from 33% of congress claiming business experience in the 100th congress
to 39% in the 116th congress to 44% in the 118th. 
<br><br>
I'm not sure why this is, but (if I had to guess) I'd mention substitution with
people who'd otherwise be in the military going to the private sector, but I'm
super unsure.
<br><br>
Even though the size trend is the opposite of the military, the partisanship
trend is in the same direction: <i>like congresspeople who served in the military,
    congresspeople who claim business experience have become more Republican.
</i> 48% of the businesspeople in the 100th congress were Democrats, but this
number was down to 39% in the 116th congress, and down to 35% in the 118th.
<br><br>
Again, I don't want to get causal, but it seems plausible that this shift could
be at least partially explained by the influx of people claiming business experience.  
<br><br>
<h3>Previous Government Experience</h3><br>
The last thing I'll touch on in this writeup is the fraction of congresspeople
with previous government experience. In their analysis, Chinoy and Ma note just
how many new representatives have no previous government experience. I calculated 
government experience a little differently from them (they didn't count unelected 
staff roles in legislative or executive offices, I did), so we got slightly different
numbers: when you don't count staff positions, you find that around 20% of the
116th congress had no prior government experience, but when you do allow staff
positions, that drops to around 16%. 
<br><br>
I didn't calculate things with their methodology for the 118th and 100th congresses,
so only take the trends — where I found around 16% of the House had no prior
government experience in the 116th congress, I found that 10% had none in the
100th congress and that 17% had none in the 118th — a clear increase, but it's
unclear how <i>significant</i> of an interest.
<br>
<br>
<h3>Methodology</h3><br>

Congress provides a JSON database of every congressperson's self-provided
biography, along with some other biographical information, at 
<a href="https://bioguide.congress.gov/">https://bioguide.congress.gov/</a>. 
After downloading their entire dataset, I dropped anyone who was both never listed
as a senator and never listed as a representative (mostly 1700s lawmakers with
basically no info) and added a new column tracking which congresses each person
served in.
<br><br>
Next, I filtered to just keep the recent folks (sessions 100-118). Cutting off
the data at the 100th congress was kinda arbitrary — I didn't want to spend
too much on Claude API credits (see below), and 40 years felt about right.
<br><br>
Then, for every senator and representative who's served since 1987, I tracked:
<br>
<ul style="padding-left:20px">
    <li>Which party they belonged to in each congress</li>
    <li>What job they held in each congress (Representative vs Senator)</li>
    <li>Which state they represented (I pulled this from the first line of their bio)</li>
    <li>Whether they served as both Representative and Senator (a few bios needed fixing here)</li>
</ul><br>
Finally, I finished processing by creating indicator variables for a variety of
career paths — <code>false</code> if, for example, the congressperson
in question didn't go to, e.g., community college, and <code>Western Wyoming
Community College</code> if they went to WWCC. The actual text of the biographies
is very nicely and consistently formatted — it's all career stages separated by
semicolons.
<br><br>
I initially did this manually to get a feel for the data, but I wrote a script
to have Claude automatically code the thousands of bios since the '80s. This
ended up setting me back % whole dollars! This is a lot for an api, and it's
probably because I used a bigger system prompt than I should've. It was definitely
worth it, though.
<br><br>
Finally, I merged in another dataset to get the specific district each representative
represented for each congress.
<br><br>
Once I had the dataset, I processed it with d3 to create the visualzation.
<br><br>
At a high level, I processed the graph data through three main steps:
<br><br>
First, I created a set of fixed coordinates for each milestone (like "Law 
School" or "Military") using a custom coordinate system. The x-axis sorta 
corresponds with time, but I sacrificed time consistency for the sake of making
all the paths proceed roughly left-to-right and only having one node per milestone.
<br><br>
I then added a bunch of "control points" — invisible nodes that help make the
paths curve nicely — between major milestones.
<br><br>
Next, for each congressperson, I created a line that connects their milestones
in chronological order. I used d3's curveCatmullRom to make the lines curve
smoothly through their points. To avoid too many paths overlapping, I added a
small vertical offset to each line based on the party of the congressperson
and how many other paths went through the same nodes. This also makes nodes with
lots of pahts though them appear larger.
<br><br>
Finally, I drew circles at each milestone whose size corresponds to how many
paths go through them. The lines connecting milestones to their labels are
dashed to distinguish them from the actual paths. I also added mouseover effects
that highlight specific paths and show tooltips with more information.
<br><br>
The final product wasn't quite as clean as the NYT version (they must've
manually adjusted some of their paths), but I think it gets the point across!
The code itself was pretty messy — lots of edge cases for different types of
career transitions — but the core visualization logic is fairly straightforward.
<br><br>
<hr>
<br>
<div style="text-align: center; width: 33%; margin: 0 auto;">
    <img src="./resources/319px-Official_congressional_portrait_of_Nan_Hayworth.jpg" alt="Congressional Portrait of Nan Hayworth" style="width: 100%; height: auto;">
</div>
<br>
<i>
    This project is dedicated to 
    <a href="https://en.wikipedia.org/wiki/Nan_Hayworth">Nan Hayworth</a>,
    former congresswoman for NY's 19th district, whose name sent me on a wild
    goose chase (pandas was "helpfully" reading her name as NaN).
</i>
<br>
<br>
<br>

            </div>
        </div>
        <div id="main-content">
            <div id="visualization"></div>
        </div>
        <script>

            const themeToggle = document.getElementById('theme-toggle');
            const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
            
            if (prefersDarkScheme.matches) {
                document.documentElement.setAttribute('data-theme', 'dark');
            }

            themeToggle.addEventListener('click', () => {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', newTheme);
            });

            const mainContent = document.getElementById('main-content');
            const width = mainContent.clientWidth;
            const height = window.innerHeight;
            // Congress selection setup
            const congressSelect = document.getElementById("congress-select");
            for (let i = 118; i >= 100; i--) {
                const suffix = i === 101 ? "st" : i === 102 ? "nd" : i === 103 ?
                    "rd" : "th";
                const option = document.createElement("option");
                option.value = i;
                option.text = `${i}${suffix} Congress`;
                congressSelect.appendChild(option);
            }
            // Create the SVG container first
            const svg = d3.select("#visualization")
                .append("svg")
                .style("width", "100%")
                .style("height", "100vh")
                .attr("viewBox", `0 0 ${width} ${height}`)
                .attr("preserveAspectRatio", "xMidYMid meet");

            function calculateStagePositions() {
                const width = window.innerWidth - 340;
                const height = window.innerHeight;
                return [
                    // everyone goes through this one
                    {
                        id: "startNode",
                        x: width * 0.05,
                        y: height * 0.5,
                        label: "",
                        labelX: 0,
                        labelY: 0
                    }, {
                        id: "eliteCollegeBefore",
                        x: width * 0.07,
                        y: height * 0.33,
                        label: "",
                        labelX: 0,
                        labelY: 0
                    }, {
                        id: "eliteCollege",
                        x: width * 0.089,
                        y: height * 0.29,
                        label: "Elite\ncollege",
                        labelX: width * 0.089,
                        labelY: height * 0.2,
                    }, {
                        id: "eliteCollegeAfter",
                        x: width * 0.13,
                        y: height * 0.29,
                        label: "",
                        labelX: 0,
                        labelY: 0
                    }, {
                        id: "privateCollege",
                        x: width * 0.1,
                        y: height * 0.39,
                        label: "Private\ncollege",
                        labelX: width * 0.1,
                        labelY: height * 0.14,
                    }, {
                        id: "privateCollegeAfter",
                        x: width * 0.13,
                        y: height * 0.38,
                        label: "",
                        labelX: 0,
                        labelY: 0
                    },
                    //{ id: "eliteCollegeLawSchoolAfter", x: width * 0.15, y: height * 0.27, label: "", labelX: 0, labelY: 0  },
                    {
                        id: "eliteCollegeMedSchoolAfter",
                        x: width * 0.14,
                        y: height * 0.31,
                        label: "",
                        labelX: 0,
                        labelY: 0
                    }, {
                        id: "eliteCollegeNoMedNoLawAfter",
                        x: width * 0.16,
                        y: height * 0.29,
                        label: "",
                        labelX: 0,
                        labelY: 0
                    }, {
                        id: "eliteCollegeNoMedNoLawMBAAfter",
                        x: width * 0.2,
                        y: height * 0.44,
                        label: "",
                        labelX: 0,
                        labelY: 0
                    }, {
                        id: "eliteCollegeNoMedNoLawMastersAfter",
                        x: width * 0.19,
                        y: height * 0.32,
                        label: "",
                        labelX: 0,
                        labelY: 0
                    }, {
                        id: "eliteCollegeNoGradAfter",
                        x: width * 0.22,
                        y: height * 0.7,
                        label: "",
                        labelX: 0,
                        labelY: 0
                    },
                    // Private college control nodes
                    {
                        id: "privateCollegeLawSchoolAfter",
                        x: width * 0.15,
                        y: height * 0.35,
                        label: "",
                        labelX: 0,
                        labelY: 0
                    }, {
                        id: "privateCollegeMedSchoolAfter",
                        x: width * 0.16,
                        y: height * 0.49,
                        label: "",
                        labelX: 0,
                        labelY: 0
                    }, {
                        id: "privateCollegeNoMedNoLawAfter",
                        x: width * 0.16,
                        y: height * 0.38,
                        label: "",
                        labelX: 0,
                        labelY: 0
                    }, {
                        id: "privateCollegeNoMedNoLawMBAAfter",
                        x: width * 0.2,
                        y: height * 0.47,
                        label: "",
                        labelX: 0,
                        labelY: 0
                    }, {
                        id: "privateCollegeNoMedNoLawMastersAfter",
                        x: width * 0.19,
                        y: height * 0.47,
                        label: "",
                        labelX: 0,
                        labelY: 0
                    }, {
                        id: "privateCollegeNoGradAfter",
                        x: width * 0.15,
                        y: height * 0.9,
                        label: "",
                        labelX: 0,
                        labelY: 0
                    }, {
                        id: "publicCollege",
                        x: width * 0.1,
                        y: height * 0.7,
                        label: "Public college",
                        labelX: width * 0.12,
                        labelY: height * 0.92,
                    },
                    //{ id: "publicCollegeAfter", x: width * 0.12, y: height * 0.71, label: "", labelX: 0, labelY: 0  },
                    {
                        id: "pubCollegeLawSchoolAfter",
                        x: width * 0.14,
                        y: height * 0.6,
                        label: "",
                        labelX: 0,
                        labelY: 0
                    }, {
                        id: "pubCollegeMedSchoolAfter",
                        x: width * 0.14,
                        y: height * 0.7,
                        label: "",
                        labelX: 0,
                        labelY: 0
                    }, {
                        id: "pubCollegeNoMedNoLawMBAAfter",
                        x: width * 0.16,
                        y: height * 0.72,
                        label: "",
                        labelX: 0,
                        labelY: 0
                    }, {
                        id: "pubCollegeNoMedNoLawMastersAfter",
                        x: width * 0.16,
                        y: height * 0.75,
                        label: "",
                        labelX: 0,
                        labelY: 0
                    },
                    //{ id: "pubCollegeNoGradAfter", x: width * 0.15, y: height * 0.9, label: "", labelX: 0, labelY: 0  },
                    {
                        id: "communityCollege",
                        x: width * 0.075,
                        y: height * 0.5,
                        label: "Commun-\nity college",
                        labelX: width * 0.06,
                        labelY: height * 0.8,
                    }, {
                        id: "noBA",
                        x: width * 0.1,
                        y: height * 0.58,
                        label: "No BA",
                        labelX: width * 0.09,
                        labelY: height * 0.86,
                    }, {
                        id: "lawSchool",
                        x: width * 0.18,
                        y: height * 0.3,
                        label: "Law school",
                        labelX: width * 0.18,
                        labelY: height * 0.15,
                    }, {
                        id: "lawThenMastersAfter",
                        x: width * 0.22,
                        y: height * 0.33,
                        label: "",
                        labelX: 0,
                        labelY: 0
                    }, {
                        id: "lawNoMAsNoPrivateAfter",
                        x: width * 0.26,
                        y: height * 0.33,
                        label: "",
                        labelX: 0,
                        labelY: 0
                    }, {
                        id: "medDegree",
                        x: width * 0.2,
                        y: height * 0.52,
                        label: "Medical\ndegree",
                        labelX: width * 0.215,
                        labelY: height * 0.2,
                    }, {
                        id: "doctorate",
                        x: width * 0.3,
                        y: height * 0.46,
                        label: "doctorate",
                        labelX: width * 0.28,
                        labelY: height * 0.17,
                    }, {
                        id: "mba",
                        x: width * 0.23,
                        y: height * 0.499,
                        label: "MBA",
                        labelX: width * 0.2,
                        labelY: height * 0.97,
                    }, {
                        id: "otherMasters",
                        x: width * 0.28,
                        y: height * 0.49,
                        label: "Other\nMaster's",
                        labelX: width * 0.28,
                        labelY: height * 0.96,
                    }, {
                        id: "privCol_noHigherEdAfter",
                        x: width * 0.23,
                        y: height * 0.8,
                        label: "",
                        labelX: 0,
                        labelY: 0
                    }, {
                        id: "pubCol_noHigherEdAfter",
                        x: width * 0.23,
                        y: height * 0.9,
                        label: "",
                        labelX: 0,
                        labelY: 0
                    }, {
                        id: "noBA_noHigherEdAfter",
                        x: width * 0.23,
                        y: height * 0.85,
                        label: "",
                        labelX: 0,
                        labelY: 0
                    }, {
                        id: "noHigherEdTopOrMiddleAfter",
                        x: width * 0.29,
                        y: height * 0.7,
                        label: "",
                        labelX: 0,
                        labelY: 0
                    }, {
                        id: "lawyerPrivatePractice",
                        x: width * 0.35,
                        y: height * 0.22,
                        label: "Lawyer\n(private practice)",
                        labelX: width * 0.35,
                        labelY: height * 0.11,
                    }, {
                        id: "lawyerPubNoPrivBefore",
                        x: width * 0.35,
                        y: height * 0.3,
                        label: "",
                        labelX: 0,
                        labelY: 0
                    }, {
                        id: "lawyerPrivatePracticeBusinessNoMilitaryAfter",
                        x: width * 0.41,
                        y: height * 0.2,
                        label: "",
                        labelX: 0,
                        labelY: 0
                    },
                    //{ id: "sciOrEng", x: width * 0.32, y: height * 0.6, label: "sciOrEng", labelX: 0, labelY: 0  },
                    {
                        id: "religion",
                        x: width * 0.31,
                        y: height * 0.9,
                        label: "religion",
                        labelX: width * 0.35,
                        labelY: height * 0.95,
                    }, {
                        id: "blueCollarOrServiceJob",
                        x: width * 0.36,
                        y: height * 0.58,
                        label: "blue-collar or\nservice job",
                        labelX: width * 0.44,
                        labelY: height * 0.92,
                    }, {
                        id: "sports",
                        x: width * 0.46,
                        y: height * 0.7,
                        label: "Sports",
                        labelX: width * 0.46,
                        labelY: height * 0.885,
                    }, {
                        id: "military",
                        x: width * 0.4,
                        y: height * 0.39,
                        label: "Military",
                        labelX: width * 0.43,
                        labelY: height * 0.1,
                    }, {
                        id: "gradBusinessAfter",
                        x: width * 0.4,
                        y: height * 0.5,
                        label: "",
                        labelX: 0,
                        labelY: 0
                    }, {
                        id: "businessBottomBefore",
                        x: width * 0.56,
                        y: height * 0.8,
                        label: "",
                        labelX: 0,
                        labelY: 0
                    }, // NEXT
                    {
                        id: "BusinessAboveBefore",
                        x: width * 0.59,
                        y: height * 0.3,
                        label: "",
                        labelX: 0,
                        labelY: 0
                    }, {
                        id: "businessOrManagement",
                        x: width * 0.58,
                        y: height * 0.5,
                        label: "Business",
                        labelX: width * 0.57,
                        labelY: height * 0.2,
                    }, {
                        id: "businessOrManagementAfter",
                        x: width * 0.6,
                        y: height * 0.5,
                        label: "",
                        labelX: 0,
                        labelY: 0
                    }, {
                        id: "lawOnlyAfter",
                        x: width * 0.41,
                        y: height * 0.2,
                        label: "",
                        labelX: 0,
                        labelY: 0
                    }, {
                        id: "militaryOnlyAfter",
                        x: width * 0.47,
                        y: height * 0.37,
                        label: "",
                        labelX: 0,
                        labelY: 0
                    }, {
                        id: "noGradNoBusinessAfter",
                        x: width * 0.51,
                        y: height * 0.8,
                        label: "",
                        labelX: 0,
                        labelY: 0
                    },
                    //{ id: "gradNoBusinessAfter", x: width * 0.43, y: height * 0.7, label: "", labelX: 0, labelY: 0  },
                    {
                        id: "media",
                        x: width * 0.62,
                        y: height * 0.8,
                        label: "Media",
                        labelX: width * 0.66,
                        labelY: height * 0.94,
                    }, {
                        id: "realEstate",
                        x: width * 0.64,
                        y: height * 0.75,
                        label: "Real\nestate",
                        labelX: width * 0.69,
                        labelY: height * 0.87,
                    }, {
                        id: "education",
                        x: width * 0.52,
                        y: height * 0.4,
                        label: "Education",
                        labelX: width * 0.52,
                        labelY: height * 0.175,
                    }, {
                        id: "farmingOrRanching",
                        x: width * 0.54,
                        y: height * 0.65,
                        label: "farming\n or ranching",
                        labelX: width * 0.585,
                        labelY: height * 0.85,
                    }, {
                        id: "healthcare",
                        x: width * 0.45,
                        y: height * 0.58,
                        label: "health-\ncare",
                        labelX: width * 0.46,
                        labelY: height * 0.135,
                    }, {
                        id: "nonprofitsAndUnions",
                        x: width * 0.45,
                        y: height * 0.65,
                        label: "Nonprofits\nor unions",
                        labelX: width * 0.55,
                        labelY: height * 0.93,
                    }, {
                        id: "publicLawyerOrJudge",
                        x: width * 0.65,
                        y: height * 0.13,
                        label: "Public lawyer\nor judge",
                        labelX: width * 0.65,
                        labelY: height * 0.06,
                    },
                    //{ id: "nonElectedGovJob", x: width * 0.69, y: height * 0.4, label: "Non-elected gov", labelX: 0, labelY: 0  },
                    {
                        id: "electedFedOrStateOffice",
                        x: width * 0.69,
                        y: height * 0.73,
                        label: "elected state-\nwide office",
                        labelX: width * 0.78,
                        labelY: height * 0.9,
                    },
                    //{ id: "stateLegBefore", x: width * 0.85, y: height * 0.49, label: "", labelX: 0, labelY: 0  },
                    {
                        id: "stateLeg",
                        x: width * 0.85,
                        y: height * 0.54,
                        label: "State\nlegislature",
                        labelX: width * 0.83,
                        labelY: height * 0.17,
                    }, {
                        id: "houseNoNonElecNoStateNoLocalBefore",
                        x: width * 0.79,
                        y: height * 0.77,
                        label: "",
                        labelX: 0,
                        labelY: 0
                    }, {
                        id: "houseNoStateLegBefore",
                        x: width * 0.85,
                        y: height * 0.8,
                        label: "",
                        labelX: 0,
                        labelY: 0
                    }, {
                        id: "localGovPubLawOrEduBefore",
                        x: width * 0.7,
                        y: height * 0.4,
                        label: "",
                        labelX: 0,
                        labelY: 0
                    }, {
                        id: "highPointNoLocalGovAfter",
                        x: width * 0.75,
                        y: height * 0.3,
                        label: "",
                        labelX: 0,
                        labelY: 0
                    }, {
                        id: "centralishPointNoLocalGovAfter",
                        x: width * 0.72,
                        y: height * 0.6,
                        label: "",
                        labelX: 0,
                        labelY: 0
                    }, {
                        id: "businessNoStateLegYesHouseAfter",
                        x: width * 0.85,
                        y: height * 0.69,
                        label: "",
                        labelX: 0,
                        labelY: 0
                    }, {
                        id: "localGov",
                        x: width * 0.75,
                        y: height * 0.45,
                        label: "Local\ngovernment",
                        labelX: width * 0.75,
                        labelY: height * 0.11,
                    },
                    //{ id: "prevUnsuccessfulCandidate", x: width * 0.67, y: height * 0.8, label: "prevUnsuccessfulCandidate" },
                    {
                        id: "senateStateLegNoHouseBefore",
                        x: width * 0.92,
                        y: height * 0.44,
                        label: "",
                        labelX: 0,
                        labelY: 0
                    }, {
                        id: "senateNoStateLegNoHouseBefore",
                        x: width * 0.87,
                        y: height * 0.3,
                        label: "",
                        labelX: 0,
                        labelY: 0
                    }, {
                        id: "prevHouse",
                        x: width * 0.89,
                        y: height * 0.4,
                        label: "previous\nHouse",
                        labelX: width * 0.89,
                        labelY: height * 0.11,
                    }, {
                        id: "congressRep",
                        x: width * 0.95,
                        y: height * 0.6,
                        label: "House",
                        labelX: width * 0.95,
                        labelY: height * 0.75,
                    }, {
                        id: "congressSen",
                        x: width * 0.95,
                        y: height * 0.4,
                        label: "Senate",
                        labelX: width * 0.95,
                        labelY: height * 0.25,
                    },
                ];
            }
            // Initialize stages
            let stages = calculateStagePositions();
            // Create tooltip div before using it
            const tooltip = d3.select("#visualization")
                .append("div")
                .attr("class", "tooltip")
                .style("opacity", 0)
                .style("position", "absolute")
                .style("background", "white")
                .style("border", "1px solid #ddd")
                .style("border-radius", "4px")
                .style("padding", "8px")
                .style("pointer-events", "none")
                .style("box-shadow", "0 2px 4px rgba(0,0,0,0.1)");
            // Process politicians data
            function processCareerStages(politician, congressNum) {
                const careerStages = ["startNode"];
                const shouldIncludeStage = (value) => {
                    if (value === true || value === "True") return true;
                    if (typeof value === "string" && value.trim()
                        .length > 0 && value !== "False") return true;
                    return false;
                };

                function isMiddlePath(stages, width) {
                    const middlePoints = ["healthcare", "education",
                        "nonprofitsAndUnions", "sciOrEng", "sports",
                        "blueCollarOrServiceJob",
                        // "businessOrManagement",
                        "farmingOrRanching"
                    ];
                    return stages.some(stage => middlePoints.includes(stage));
                }
                let hasHigherEd = false;
                if (shouldIncludeStage(politician.eliteCollege)) {
                    if (shouldIncludeStage(politician.communityCollege)) {
                        careerStages.push("eliteCollege");
                        careerStages.push("eliteCollegeAfter");
                    } else {
                        careerStages.push("eliteCollegeBefore");
                        careerStages.push("eliteCollege");
                        careerStages.push("eliteCollegeAfter");
                    }
                    if (shouldIncludeStage(politician.lawSchool)) {
                        careerStages.push("eliteCollegeLawSchoolAfter");
                    } else if (shouldIncludeStage(politician.medDegree)) {
                        careerStages.push("eliteCollegeMedSchoolAfter");
                    } else if (!shouldIncludeStage(politician.medDegree) && !
                        shouldIncludeStage(politician.lawSchool) &&
                        shouldIncludeStage(politician.mba)) {
                        careerStages.push("eliteCollegeNoMedNoLawMBAAfter");
                    } else if (!shouldIncludeStage(politician.medDegree) && !
                        shouldIncludeStage(politician.lawSchool) && !
                        shouldIncludeStage(politician.mba) &&
                        shouldIncludeStage(politician.otherMasters)) {
                        careerStages.push("eliteCollegeNoMedNoLawMastersAfter");
                    } else if (!shouldIncludeStage(politician.medDegree) && !
                        shouldIncludeStage(politician.lawSchool) && !
                        shouldIncludeStage(politician.mba) && !
                        shouldIncludeStage(politician.otherMasters)) {
                        careerStages.push("eliteCollegeNoGradAfter");
                    }
                }
                // Private College path
                else if (shouldIncludeStage(politician.privateCollege)) {
                    careerStages.push("privateCollege");
                    careerStages.push("privateCollegeAfter");
                    if (shouldIncludeStage(politician.lawSchool)) {
                        careerStages.push("privateCollegeLawSchoolAfter");
                    } else if (shouldIncludeStage(politician.medDegree)) {
                        careerStages.push("privateCollegeMedSchoolAfter");
                    } else if (!shouldIncludeStage(politician.medDegree) && !
                        shouldIncludeStage(politician.lawSchool) &&
                        shouldIncludeStage(politician.mba)) {
                        careerStages.push("privateCollegeNoMedNoLawMBAAfter");
                    } else if (!shouldIncludeStage(politician.medDegree) && !
                        shouldIncludeStage(politician.lawSchool) && !
                        shouldIncludeStage(politician.mba) &&
                        shouldIncludeStage(politician.otherMasters)) {
                        careerStages.push(
                            "privateCollegeNoMedNoLawMastersAfter");
                    } else if (!shouldIncludeStage(politician.medDegree) && !
                        shouldIncludeStage(politician.lawSchool)) {
                        careerStages.push("privateCollegeNoMedNoLawAfter");
                    } else if (!shouldIncludeStage(politician.medDegree) && !
                        shouldIncludeStage(politician.lawSchool) && !
                        shouldIncludeStage(politician.mba) && !
                        shouldIncludeStage(politician.otherMasters)) {
                        careerStages.push("privateCollegeNoGradAfter");
                    }
                }
                // Public College path (existing code)
                else if (shouldIncludeStage(politician.publicCollege)) {
                    careerStages.push("publicCollege");
                    careerStages.push("publicCollegeAfter");
                    if (shouldIncludeStage(politician.lawSchool)) {
                        careerStages.push("pubCollegeLawSchoolAfter");
                    } else if (shouldIncludeStage(politician.medDegree)) {
                        careerStages.push("pubCollegeMedSchoolAfter");
                    } else if (!shouldIncludeStage(politician.medDegree) && !
                        shouldIncludeStage(politician.lawSchool) &&
                        shouldIncludeStage(politician.mba)) {
                        careerStages.push("pubCollegeNoMedNoLawMBAAfter");
                    } else if (!shouldIncludeStage(politician.medDegree) && !
                        shouldIncludeStage(politician.lawSchool) && !
                        shouldIncludeStage(politician.mba) &&
                        shouldIncludeStage(politician.otherMasters)) {
                        careerStages.push("pubCollegeNoMedNoLawMastersAfter");
                    } else if (!shouldIncludeStage(politician.medDegree) && !
                        shouldIncludeStage(politician.lawSchool)) {
                        careerStages.push("pubCollegeNoMedNoLawAfter");
                    } else if (!shouldIncludeStage(politician.medDegree) && !
                        shouldIncludeStage(politician.lawSchool) && !
                        shouldIncludeStage(politician.mba) && !
                        shouldIncludeStage(politician.otherMasters)) {
                        careerStages.push("pubCollegeNoGradAfter");
                    }
                } else {
                    careerStages.push("noBA");
                }
                // Community college and no BA can still be included independently
                if (shouldIncludeStage(politician.communityCollege))
                    careerStages.push("communityCollege");
                // if (shouldIncludeStage(politician.noBA)) careerStages.push('noBA');
                if (shouldIncludeStage(politician.lawSchool)) {
                    careerStages.push("lawSchool");
                    hasHigherEd = true;
                    if (shouldIncludeStage(politician.otherMasters)) {
                        careerStages.push("lawThenMastersAfter");
                    } else if (!shouldIncludeStage(politician.mba) && !
                        shouldIncludeStage(politician.lawyerPrivatePractice)) {
                        careerStages.push("lawNoMAsNoPrivateAfter");
                    }
                }
                if (shouldIncludeStage(politician.mba)) {
                    careerStages.push("mba");
                    hasHigherEd = true;
                }
                if (shouldIncludeStage(politician.otherMasters)) {
                    careerStages.push("otherMasters");
                    hasHigherEd = true;
                }
                if (shouldIncludeStage(politician.medDegree)) {
                    careerStages.push("medDegree");
                    hasHigherEd = true;
                }
                if (shouldIncludeStage(politician.doctorate)) {
                    careerStages.push("doctorate");
                    hasHigherEd = true;
                }
                if (!hasHigherEd) {
                    if (careerStages.includes("noBA")) {
                        careerStages.push("noBA_noHigherEdAfter");
                    } else if (shouldIncludeStage(politician.publicCollege)) {
                        careerStages.push("pubCol_noHigherEdAfter");
                    } else if (shouldIncludeStage(politician.privateCollege)) {
                        careerStages.push("privCol_noHigherEdAfter");
                    }
                }
                if (shouldIncludeStage(politician.sports)) careerStages.push(
                    "sports");
                if (shouldIncludeStage(politician.military)) careerStages.push(
                    "military");
                if (shouldIncludeStage(politician.businessOrManagement))
                    careerStages.push("businessOrManagement");
                if (shouldIncludeStage(politician.lawyerPrivatePractice) && !
                    shouldIncludeStage(politician.businessOrManagement) && !
                    shouldIncludeStage(politician.military)) {
                    careerStages.push("lawOnlyAfter");
                }
                if (shouldIncludeStage(politician.military) && !
                    shouldIncludeStage(politician.businessOrManagement) && !
                    shouldIncludeStage(politician.lawyerPrivatePractice)) {
                    careerStages.push("militaryOnlyAfter");
                }
                if (shouldIncludeStage(politician.lawSchool) && !
                    shouldIncludeStage(politician.lawyerPrivatePractice) &&
                    shouldIncludeStage(politician.publicLawyerOrJudge)) {
                    careerStages.push("lawyerPubNoPrivBefore");
                }
                if (shouldIncludeStage(politician.lawyerPrivatePractice) && !
                    shouldIncludeStage(politician.military) &&
                    shouldIncludeStage(politician.businessOrManagement)) {
                    careerStages.push(
                        "lawyerPrivatePracticeBusinessNoMilitaryAfter");
                }
                if (!hasHigherEd && !shouldIncludeStage(politician.military) &&
                    !shouldIncludeStage(politician.businessOrManagement) && !
                    shouldIncludeStage(politician.education)) {
                    careerStages.push("noGradNoBusinessAfter");
                }
                if (hasHigherEd && !shouldIncludeStage(politician
                        .businessOrManagement) && !shouldIncludeStage(politician
                        .military) && !shouldIncludeStage(politician
                        .lawyerPrivatePractice) && !shouldIncludeStage(
                        politician.publicLawyerOrJudge)) careerStages.push(
                    "gradNoBusinessAfter");
                if (hasHigherEd && shouldIncludeStage(politician
                        .businessOrManagement)) {
                    if (!shouldIncludeStage(politician.military) && !
                        shouldIncludeStage(politician.lawyerPrivatePractice)) {
                        careerStages.push("gradBusinessAfter");
                    }
                }
                if (careerStages.some(stage => ['farmingOrRanching', 'sports',
                        'religion', 'blueCollarOrServiceJob', 'healthcare'
                    ].includes(stage)) && !careerStages.includes(
                        "businessOrManagement")) {
                    careerStages.push("businessBottomBefore");
                }
                if (shouldIncludeStage(politician.media)) careerStages.push(
                    "media");
                if (shouldIncludeStage(politician.realEstate)) careerStages
                    .push("realEstate");
                if (shouldIncludeStage(politician.lawyerPrivatePractice))
                    careerStages.push("lawyerPrivatePractice");
                if (shouldIncludeStage(politician.sciOrEng)) careerStages.push(
                    "sciOrEng");
                if (shouldIncludeStage(politician.religion)) careerStages.push(
                    "religion");
                if (shouldIncludeStage(politician.blueCollarOrServiceJob))
                    careerStages.push("blueCollarOrServiceJob");
                if (shouldIncludeStage(politician.healthcare)) careerStages
                    .push("healthcare");
                if (shouldIncludeStage(politician.education)) careerStages.push(
                    "education");
                if (shouldIncludeStage(politician.farmingOrRanching))
                    careerStages.push("farmingOrRanching");
                if ((careerStages.includes("noBA_noHigherEdAfter") ||
                        careerStages.includes("pubCol_noHigherEdAfter") ||
                        careerStages.includes("privCol_noHigherEdAfter")) && (
                        careerStages.includes("military") || careerStages
                        .includes("blueCollarOrServiceJob") || careerStages
                        .includes("healthcare"))) {
                    careerStages.push("noHigherEdTopOrMiddleAfter");
                }
                if (!shouldIncludeStage(politician.businessOrManagement) && !
                    shouldIncludeStage(politician.farmingOrRanching) && !
                    shouldIncludeStage(politician.sports) && !
                    shouldIncludeStage(politician.healthcare) && !careerStages
                    .includes("noGradNoBusinessAfter")) {
                    careerStages.push("BusinessAboveBefore");
                }
                if (shouldIncludeStage(politician.nonprofitsAndUnions))
                    careerStages.push("nonprofitsAndUnions");
                if (shouldIncludeStage(politician.publicLawyerOrJudge))
                    careerStages.push("publicLawyerOrJudge");
                if (shouldIncludeStage(politician.electedFedOrStateOffice))
                    careerStages.push("electedFedOrStateOffice");
                if (shouldIncludeStage(politician.nonElectedGovJob))
                    careerStages.push("nonElectedGovJob");
                if (shouldIncludeStage(politician.stateLeg)) {
                    careerStages.push("stateLegBefore");
                    careerStages.push("stateLeg");
                    careerStages.push("stateLegAfter");
                }
                if (shouldIncludeStage(politician.localGov)) {
                    if (
                        (shouldIncludeStage(politician.publicLawyerOrJudge) ||
                            shouldIncludeStage(politician
                            .lawyerPrivatePractice) || shouldIncludeStage(
                                politician.military)) && (!shouldIncludeStage(
                                politician.electedFedOrStateOffice) && !
                            shouldIncludeStage(politician
                                .prevUnsuccessfulCandidate))) {
                        careerStages.push("localGovPubLawOrEduBefore");
                    }
                    careerStages.push("localGov")
                } else if (!shouldIncludeStage(politician
                    .publicLawyerOrJudge) && !shouldIncludeStage(politician
                        .electedFedOrStateOffice) && !shouldIncludeStage(
                        politician.prevUnsuccessfulCandidate) && !
                    shouldIncludeStage(politician.media)) {
                    careerStages.push("centralishPointNoLocalGovAfter");
                }
                if (!shouldIncludeStage(politician.businessOrManagement) && !
                    shouldIncludeStage(politician.education) && !
                    shouldIncludeStage(politician.farmingOrRanching) && !
                    shouldIncludeStage(politician.media) && !shouldIncludeStage(
                        politician.realEstate) && !shouldIncludeStage(politician
                        .electedFedOrStateOffice) && !shouldIncludeStage(
                        politician.localGov) && !careerStages.includes(
                        "centralishPointNoLocalGovAfter")) {
                    careerStages.push("highPointNoLocalGovAfter");
                };
                if (shouldIncludeStage(politician.prevUnsuccessfulCandidate))
                    careerStages.push("prevUnsuccessfulCandidate");
                const congressJob = politician.jobs[congressNum];
                if (congressJob === "Senator") {
                    for (let i = 0; i < congressNum; i++) {
                        if (politician.jobs[i] === "Representative") {
                            careerStages.push("prevHouse");
                            break;
                        }
                    }
                    if (!careerStages.includes("prevHouse")) {
                        if (shouldIncludeStage(politician.stateLeg)) {
                            careerStages.push("senateStateLegNoHouseBefore")
                        } else {
                            careerStages.push("senateNoStateLegNoHouseBefore")
                        };
                    }
                    careerStages.push("congressSen");
                } else if (shouldIncludeStage(politician.jobs[congressNum] ===
                        "Representative")) {
                    if (!shouldIncludeStage(politician.stateLeg)) {
                        if (!shouldIncludeStage(politician.localGov) && !
                            shouldIncludeStage(politician
                                .electedFedOrStateOffice)) {
                            careerStages.push(
                                "houseNoNonElecNoStateNoLocalBefore");
                        } {
                            if (shouldIncludeStage(politician
                                    .businessOrManagement)) {
                                const index = careerStages.indexOf(
                                    "highPointNoLocalGovAfter");
                                if (index > -1) careerStages.splice(index, 1);
                                careerStages.push(
                                    "businessNoStateLegYesHouseAfter");
                            } else {
                                careerStages.push("houseNoStateLegBefore");
                            }
                        }
                    }
                    careerStages.push("congressRep");
                }
                return {
                    id: politician.id,
                    name: `${politician.givenName} ${politician.familyName}`,
                    unaccentedName: `${politician.unaccentedGivenName} ${politician.unaccentedFamilyName}`,
                    stages: careerStages,
                    color: politician.parties[congressNum] === "D" ?
                        "#268AB9" : politician.parties[congressNum] === "R" ?
                        "#FF3C51" : "#808080",
                    party: politician.parties[congressNum],
                    district: politician.district[congressNum],
                    role: politician.jobs[congressNum],
                    state: politician.state,
                };
            }
            let selectedPaths = new Set();
            let currentPoliticians = [];

            function updateVisualization(congressNum) {
                // Clear existing viz
                svg.selectAll("*")
                    .remove();
                selectedPaths.clear();
                d3.json("./data/processed/processed-bios.json")
                    .then((data) => {
                        const activePoliticians = Object.values(data)
                            .filter((p) => p.jobs[congressNum] !== null);
                        const allPoliticians = activePoliticians.map((p) =>
                            processCareerStages(p, congressNum));
                        sampledPoliticians = allPoliticians;
                        currentPoliticians = allPoliticians;
                        //.sort(() => 0.5 - Math.random());
                        //.slice(0, 500);
                        const searchInput = document.querySelector(
                            '.search-input');
                        const dropdown = document.querySelector(
                        '.dropdown');
                        updateDropdown();
                        const nodeTraffic = new Map(stages.map((stage) => [
                        stage.id, {
                                count: 0,
                                pathIndices: [],
                                stageId: stage.id
                        }
                    ]), );
                        sampledPoliticians.forEach((politician,
                            pathIndex) => {
                                politician.stages.forEach((stageId) => {
                                    const traffic = nodeTraffic
                                        .get(stageId);
                                    if (traffic) {
                                        traffic.count++;
                                        traffic.pathIndices
                                            .push(pathIndex);
                                    }
                                });
                            });
                        drawPaths();
                        drawNodes();

                        function drawNodes() {
                            const lineHeight = 1.2;

    
                            const nodes = svg.selectAll(".node-label")
                                .data(stages.filter(d => d.label && !d.id.includes("Before") && !d.id.includes("After")))
                                .enter()
                                .append("text")
                                .attr("class", "node-label")
                                .attr("x", d => d.labelX)
                                .attr("y", d => d.labelY)
                                .attr("text-anchor", "start");

                            // Add tspans for multiline text
                            nodes.each(function(d) {
                                const lines = d.label.split("\n");
                                const text = d3.select(this);
                                const numLines = lines.length;
                                
                                lines.forEach((line, i) => {
                                    text.append("tspan")
                                        .attr("x", d.labelX)
                                        .attr("dy", i === 0 ? 0 : lineHeight + "em")
                                        .text(line);
                                });
                            });

                            nodes
                                .filter(d => d.id === "congressRep" || d.id === "congressSen")
                                .classed("congress-label", true)
                                .classed("node-label", false);

                            svg.selectAll(".congress-label")
                                .append("text")
                                .attr("class", "node-label")
                                .attr("x", d => d.labelX)
                                .attr("y", d => d.labelY)
                                .attr("text-anchor", "start")
                                .selectAll("tspan")
                                .data(d => d.label.split("\n"))
                                .enter()
                                .append("tspan")
                                .attr("x", function() { 
                                    return d3.select(this.parentNode).attr("x");
                                })
                                .attr("dy", (d, i) => i === 0 ? 0 : "1.2em")
                                .text(d => d);

                            svg.selectAll("circle")
                                .data(stages.filter(d => !["startNode",
                                        "congressRep",
                                    "congressSen"
                                ].includes(d.id) && !d.id.includes("Before") && !d
                                    .id.includes("After")))
                                .enter()
                                .append("circle")
                                .attr("class", "node")
                                .attr("cx", d => d.x)
                                .attr("cy", d => d.y)
                                .attr("r", d => {
                                    const traffic = nodeTraffic.get(d
                                            .id)
                                        ?.count || 0;
                                    return traffic / 8;
                                })
                                .style("fill", "none")
                                //.style("stroke", "#000")
                                .style("stroke-width", 1)
                                .on("mouseover", handleNodeMouseOver)
                                .on("mouseout", handleNodeMouseOut);

                            // Adjust line connections based on label position and text height
                            svg.selectAll(".label-line")
                                .data(stages.filter(d => d.label && !d.id.includes("Before") && !d.id.includes("After")))
                                .enter()
                                .append("line")
                                .attr("class", "label-line")
                                .attr("x1", d => d.x)
                                .attr("y1", d => d.y)
                                .attr("x2", d => d.labelX)
                                .attr("y2", d => {
                                    const lines = d.label.split("\n");
                                    const textHeight = lines.length * lineHeight;
                                    const midpoint = height / 2;
                                    
                                    // If label is above midline, connect to bottom of text
                                    // If label is below midline, connect to top of text
                                    return d.labelY < midpoint ? 
                                        d.labelY + (textHeight * 1.2) : // Add some padding
                                        d.labelY;
                                })
                                //.style("stroke", "#666")
                                .style("stroke-width", 1)
                                .style("stroke-dasharray", "3,3");
                        }

                        function drawPaths() {
                            const line = d3.line()
                                .x((d) => d.x)
                                .y((d) => d.y)
                                .curve(d3.curveCatmullRom.alpha(0.3));
                            sampledPoliticians.forEach((politician,
                                pathIndex) => {
                                const pathPoints = politician.stages
                                    .map((stageId) => {
                                        const stage = stages
                                            .find((s) => s
                                                .id === stageId
                                                );
                                        if (!stage) return null;
                                        const traffic =
                                            nodeTraffic.get(
                                                stageId);
                                        const offset = traffic ?
                                            calculateOffset(
                                                traffic,
                                                pathIndex) : 0;
                                        return {
                                            x: stage.x,
                                            y: stage.y + offset
                                        };
                                    })
                                    .filter((point) => point !==
                                        null)
                                    .sort((a, b) => a.x - b.x);
                                svg.append("path")
                                    .attr("class", "path")
                                    .datum(politician)
                                    .attr("d", line(pathPoints))
                                    .style("stroke", politician
                                        .color)
                                    .style("opacity", 0.6)
                                    .style("stroke-width", "1.25px")
                                    .on("mouseover", (event) =>
                                        handlePathMouseOver(event,
                                            politician))
                                    .on("mouseout",
                                        handlePathMouseOut);
                            });
                        }

                        function updateDropdown(filter = '') {
                            const filteredPoliticians = currentPoliticians
                                .filter(p => p.unaccentedName.toLowerCase()
                                    .includes(filter.toLowerCase()));
                            dropdown.innerHTML = filteredPoliticians.map(
                                    p => {
                                        // Check if they're a Senator
                                        const isSenator = p.role ===
                                            "Senator";
                                        // Format the display string based on whether they're a Senator or Representative
                                        const displayString = isSenator ?
                                            `${p.name} (${p.party}-${p.state} Senator)` :
                                            `${p.name} (${p.party}-${p.state}-${p.district})`;
                                        return `<div class="dropdown-item" data-index="${currentPoliticians.indexOf(p)}">${displayString}</div>`;
                                    })
                                .join('');
                            dropdown.classList.toggle('show', filter !==
                            '');
                        }
                        searchInput.addEventListener('input', (e) => {
                            updateDropdown(e.target.value);
                        });
                        dropdown.addEventListener('mouseover', (e) => {
                            const item = e.target.closest(
                                '.dropdown-item');
                            if (item) {
                                const index = parseInt(item.dataset
                                    .index);
                                const politician =
                                    currentPoliticians[index];
                                const path = svg.selectAll('.path')
                                    .filter(d => d.name ===
                                        politician.name)
                                    .node();
                                if (path) {
                                    handlePathMouseOver({
                                        target: path,
                                        pageX: e.pageX,
                                        pageY: e.pageY
                                    }, politician);
                                }
                            }
                        });
                        dropdown.addEventListener('mouseout', (e) => {
                            const item = e.target.closest(
                                '.dropdown-item');
                            if (item) {
                                handlePathMouseOut();
                            }
                        });
                        dropdown.addEventListener('click', (e) => {
                            const item = e.target.closest(
                                '.dropdown-item');
                            if (item) {
                                const index = parseInt(item.dataset
                                    .index);
                                const politician =
                                    currentPoliticians[index];
                                // Clear previous persistent highlights
                                svg.selectAll(".path")
                                    .classed("persistent-highlight",
                                        false)
                                    .style("opacity", 0.6)
                                    .style("stroke-width", "1.5px");
                                // Add persistent highlight to selected path
                                svg.selectAll(".path")
                                    .filter(d => d.name ===
                                        politician.name)
                                    .classed("persistent-highlight",
                                        true)
                                    .style("opacity", 1)
                                    .style("stroke-width", "3px");
                                // Update search input with selected name
                                searchInput.value = politician.name;
                                dropdown.classList.remove('show');
                                // Highlight relevant nodes
                                svg.selectAll(
                                        ".node, .node-label, .label-line"
                                        )
                                    .style("opacity", 0.1);
                                politician.stages.forEach(
                                stageId => {
                                    svg.selectAll(".node")
                                        .filter(d => d
                                            .id === stageId)
                                        .style("opacity",
                                        1);
                                    svg.selectAll(
                                            ".node-label")
                                        .filter(d => d
                                            .id === stageId)
                                        .style("opacity",
                                        1);
                                    svg.selectAll(
                                            ".label-line")
                                        .filter(d => d
                                            .id === stageId)
                                        .style("opacity",
                                        1);
                                });
                            }
                        });
                        svg.on("click", (event) => {
                            // Check if click was directly on the SVG background
                            if (event.target === svg.node()) {
                                // Reset all highlighting
                                svg.selectAll(".path")
                                    .style("opacity", 0.6)
                                    .style("stroke-width", "1.5px")
                                    .each(function() {
                                        d3.select(this)
                                            .classed(
                                                "persistent-highlight",
                                                false);
                                    });
                                svg.selectAll(
                                        ".node, .node-label, .label-line"
                                        )
                                    .style("opacity", 1);
                                // Hide tooltip
                                tooltip.transition()
                                    .duration(500)
                                    .style("opacity", 0);
                                // Clear search input and hide dropdown
                                document.querySelector(
                                        '.search-input')
                                    .value = '';
                                document.querySelector('.dropdown')
                                    .classList.remove('show');
                            }
                        });
                    })
                    .catch((error) => {
                        console.error("Error loading the JSON file:",
                        error);
                    });
            }
            congressSelect.addEventListener("change", (event) => {
                updateVisualization(parseInt(event.target.value));
            });
            updateVisualization(118);
            // Event handlers
            function handleNodeMouseOver(event, d) {
                const traffic = nodeTraffic.get(d.id);
                svg.selectAll(".path")
                    .style("opacity", (pathElement) => {
                        const politician = d3.select(pathElement)
                            .datum();
                        return politician.stages.includes(d.id) ? 1 : 0.1;
                        // const pathIndex = sampledPoliticians.indexOf(path);
                        // return traffic.pathIndices.includes(pathIndex) ? '3px' : '1.5px';
                    })
                    .style("stroke-width", (pathElement) => {
                        const politician = d3.select(pathElement)
                            .datum();
                        return politician.stages.includes(d.id) ? "3px" :
                            "1.5px";
                    });
                tooltip.transition()
                    .duration(200)
                    .style("opacity", 0.9);
                tooltip.html(`
                        <strong>${d.label}</strong><br/>
                        Paths: ${traffic ? traffic.count : 0}
                    `, )
                    .style("left", (event.pageX - 340) + 10 + "px")
                    .style("top", event.pageY - 28 + "px");
            }

            function handleNodeMouseOut() {
                svg.selectAll(".path")
                    .style("opacity", 0.6)
                    .style("stroke-width", "1.5px");
                tooltip.transition()
                    .duration(500)
                    .style("opacity", 0);
            }

            function handlePathMouseOver(event, politician) {
                // Dim all paths
                svg.selectAll(".path")
                    .style("opacity", 0.05)
                    .style("stroke-width", "1.5px");
                // Highlight selected path
                d3.select(event.target)
                    .style("opacity", 1)
                    .style("stroke-width", "3px");
                // Dim all nodes and labels
                svg.selectAll(".node")
                    .style("opacity", 0.1);
                svg.selectAll(".node-label")
                    .style("opacity", 0.1);
                svg.selectAll(".label-line")
                    .style("opacity", 0.1);
                // Highlight relevant nodes and labels
                politician.stages.forEach((stageId) => {
                    const stage = stages.find((s) => s.id === stageId);
                    if (stage) {
                        svg.selectAll(".node")
                            .filter((d) => d.id === stageId)
                            .style("opacity", 1);
                        svg.selectAll(".node-label")
                            .filter((d) => d.id === stageId)
                            .style("opacity", 1);
                        svg.selectAll(".label-line")
                            .filter((d) => d.id === stageId)
                            .style("opacity", 1);
                    }
                });
                tooltip.transition()
                    .duration(200)
                    .style("opacity", 0.9);
                tooltip.html(`
                        <strong>${politician.name}</strong><br/>
                        ${politician.party} - ${politician.state}
                    `, )
                    .style("left", (event.pageX - 340) + 10 + "px")
                    .style("top", event.pageY - 28 + "px")
                    .style("color", politician.color);
                if (!d3.select(event.target)
                    .classed("persistent-highlight")) {
                    svg.selectAll(".path")
                        .filter(d => !d3.select(d)
                            .classed("persistent-highlight"))
                        .style("opacity", 0.05)
                        .style("stroke-width", "1.5px");
                }
            }
            function handlePathMouseOut(event) {
                svg.selectAll(".path")
                    .each(function(d) {
                        const path = d3.select(this);
                        if (!path.classed("persistent-highlight")) {
                            path.style("opacity", 0.6)
                                .style("stroke-width", "1.5px");
                        }
                    });
                svg.selectAll(".node, .node-label, .label-line")
                    .style("opacity", 1);
                tooltip.transition()
                    .duration(500)
                    .style("opacity", 0);
            }

            function calculateOffset(traffic, pathIndex) {
                if (["startNode", "congressRep", "congressSen"].includes(traffic
                        .stageId)) {
                    return 0;
                }
                const politician = sampledPoliticians[pathIndex];
                const spread = 0.35; // Spread between paths within same party

                const democratPaths = traffic.pathIndices.filter((i) =>
                    sampledPoliticians[i].party === "D");
                const republicanPaths = traffic.pathIndices.filter((i) =>
                    sampledPoliticians[i].party === "R");
                const otherPaths = traffic.pathIndices.filter((i) => !["D", "R"]
                    .includes(sampledPoliticians[i].party));

                const totalPaths = traffic.pathIndices.length;
                const baseSeparation = 0.19 * (0.5 * democratPaths.length + 0.5 *
                    republicanPaths.length); // SPREAD BTWN PARTIES

                const partyPaths = politician.party === "D" ? democratPaths :
                    politician.party === "R" ? republicanPaths : otherPaths;
                const partyPosition = partyPaths.indexOf(pathIndex);
                const totalWidth = (partyPaths.length - 1) * spread;

                let baseOffset = 0;
                if (politician.party === "D") {
                    baseOffset = -baseSeparation;
                } else if (politician.party === "R") {
                    baseOffset = baseSeparation;
                }
                // Add spread within party group
                return baseOffset + (partyPosition * spread - totalWidth / 3);
            }

            document.querySelectorAll('.highlight-box').forEach(box => {
                box.addEventListener('mouseover', (event) => {
                    const condition = box.dataset.highlightCondition;

                    svg.selectAll(".path")
                    .style("opacity", 0.05)
                    .style("stroke-width", "1.5px");

                    svg.selectAll(".path")
                    .filter(politician => eval(condition))
                    .style("opacity", 1)
                    .style("stroke-width", "3px");

                    // Dim all nodes and labels
                    svg.selectAll(".node, .node-label, .label-line")
                    .style("opacity", 0.1);

                    // Highlight nodes used in matching paths
                    svg.selectAll(".path")
                    .filter(politician => eval(condition))
                    .each(politician => {
                        politician.stages.forEach(stageId => {
                        svg.selectAll(".node")
                            .filter(d => d.id === stageId)
                            .style("opacity", 1);
                        svg.selectAll(".node-label")
                            .filter(d => d.id === stageId)
                            .style("opacity", 1);
                        svg.selectAll(".label-line")
                            .filter(d => d.id === stageId)
                            .style("opacity", 1);
                        });
                    });
                });

                box.addEventListener('mouseout', () => {
                    svg.selectAll(".path")
                    .each(function(d) {
                        const path = d3.select(this);
                        if (!path.classed("persistent-highlight")) {
                        path.style("opacity", 0.6)
                            .style("stroke-width", "1.5px");
                        }
                    });
                    svg.selectAll(".node, .node-label, .label-line")
                    .style("opacity", 0.8);
                });
                });


        </script>
    </body>

</html>
