<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Congressional Career Paths</title>
    <style>
        /* Reset default margins and padding */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Ensure the body takes full viewport height */
        body {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        /* Style the visualization container */
        #visualization {
            width: 100%;
            height: 100%;
            background-color: white;
        }

        .congress-select {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            padding: 8px;
            font-size: 14px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        /* Path styles */
        .path {
            fill: none;
            stroke-width: 2;
            opacity: 0.7;
        }

        /* Node styles */
        .node {
            fill: white;
            stroke: black;
            stroke-width: 1;
        }

        /* Label styles */
        .node-label {
            font-size: 12px;
            font-family: Arial, sans-serif;
            text-anchor: middle;
        }

        .politician-label {
            font-size: 12px;
            font-family: Arial, sans-serif;
            text-anchor: start;
        }

        /* Tooltip styles */
        .tooltip {
            position: absolute;
            padding: 8px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            pointer-events: none;
            font-family: Arial, sans-serif;
            font-size: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
</head>
<body>
    <select id="congress-select" class="congress-select">
        <!--options will be populated by js-->
    </select>
    <div id="visualization"></div>
    <script>
        // Congress selection setup
        const congressSelect = document.getElementById('congress-select');
        for (let i = 118; i >= 100; i--) {
            const suffix = i === 101 ? 'st' : i === 102 ? 'nd' : i === 103 ? 'rd' : 'th';
            const option = document.createElement('option');
            option.value = i;
            option.text = `${i}${suffix} Congress`;
            congressSelect.appendChild(option);
        }

        // Constants and setup
        const width = window.innerWidth;
        const height = window.innerHeight;

        // Create the SVG container first
        const svg = d3.select('#visualization')
            .append('svg')
            .style('width', '100%')
            .style('height', '100vh')
            .attr('viewBox', `0 0 ${width} ${height}`)
            .attr('preserveAspectRatio', 'xMidYMid meet');

        function calculateStagePositions() {
            const width = window.innerWidth;
            const height = window.innerHeight;

            return [
                // everyone goes through this one
                {id: 'startNode', x: width * 0.05, y: height * 0.5, label: ''},

                {id: 'eliteCollegeBefore', x:  width * 0.07, y: height * 0.33, label: ''},
                {id: 'eliteCollege', x:  width * 0.089, y: height * 0.29, label: 'Elite college'},
                {id: 'eliteCollegeAfter', x: width * 0.13, y: height * 0.29, label: ''},
                {id: 'privateCollege', x:  width * 0.09, y: height * 0.38, label: 'Private college'},
                {id: 'privateCollegeAfter', x:  width * 0.13, y: height * 0.38, label: ''},

                {id: 'publicCollege', x: width * 0.10, y: height * 0.7, label: 'Public college'},
                {id: 'publicCollegeAfter', x:  width * 0.13, y: height * 0.7, label: ''},
                {id: 'communityCollege', x: width * 0.075, y: height * 0.5, label: 'Community college'},
                {id: 'noBA', x:  width * 0.09, y: height * 0.5, label: 'No BA'},

                {id: 'lawSchool', x:  width * 0.2, y: height * 0.40, label: 'Law school'},
                {id: 'medDegree', x:  width * 0.2, y: height * 0.49, label: 'Medical degree'},
                {id: 'doctorate', x:  width * 0.3, y: height * 0.46, label: 'doctorate'},
                {id: 'mba', x:  width * 0.23, y: height * 0.5, label: 'MBA'},
                {id: 'otherMasters', x:  width * 0.27, y: height * 0.49, label: 'Master\'s'},
                {id: 'noHigherEdAfter', x: width * 0.23, y: height * 0.8, label: ''},

                {id: 'lawyerPrivatePractice', x:  width * 0.35, y: height * 0.2, label: 'Lawyer (private practice)'},
                {id: 'lawyerPrivatePracticeBusinessNoMilitaryAfter', x:  width * 0.41, y: height * 0.27, label: ''},
                {id: 'sciOrEng', x:  width * 0.32, y: height * 0.6, label: 'sciOrEng'},
                {id: 'religion', x:  width * 0.31, y: height * 0.9, label: 'religion'},
                {id: 'blueCollarOrServiceJob', x:  width * 0.29, y: height * 0.9, label: 'blueCollarOrServiceJob'},
                {id: 'sports', x:  width * 0.3, y: height * 0.7, label: 'Sports'},
                {id: 'military', x:  width * 0.4, y: height * 0.37, label: 'Military'},

                {id: 'businessOrManagement', x:  width * 0.47, y: height * 0.5, label: 'Business'},

                {id: 'lawOnlyAfter', x: width * 0.47, y: height * 0.2, label: ''},
                {id: 'militaryOnlyAfter', x: width * 0.47, y: height * 0.37, label: ''},
                {id: 'noGradNoBusinessAfter', x: width * 0.47, y: height * 0.8, label: ''},
                {id: 'gradNoBusinessAfter', x: width * 0.47, y: height * 0.7, label: ''},

                {id: 'media', x:  width * 0.8, y: height * 0.9, label: 'Media'},
                {id: 'realEstate', x:  width * 0.8, y: height * 0.9, label: 'Real estate'},

                {id: 'healthcare', x:  width * 0.8, y: height * 0.9, label: 'healthcare'},
                {id: 'education', x:  width * 0.8, y: height * 0.9, label: 'education'},
                {id: 'farmingOrRanching', x:  width * 0.8, y: height * 0.9, label: 'farmingOrRanching'},
                {id: 'healthcare', x:  width * 0.8, y: height * 0.9, label: 'healthcare'},

                {id: 'nonprofitsAndUnions', x:  width * 0.8, y: height * 0.9, label: 'Nonprofits'},
                {id: 'publicLawyerOrJudge', x:  width * 0.8, y: height * 0.9, label: 'Public lawyer'},
                {id: 'nonElectedGovJob', x:  width * 0.8, y: height * 0.9, label: 'Non-elected gov'},

                {id: 'stateLegBefore', x: width * 0.8, y: height * 0.9, label: ''},
                {id: 'stateLeg', x: width * 0.85, y: height * 0.49, label: 'stateLeg'},

                {id: 'localGov', x:  width * 0.8, y: height * 0.9, label: 'localGov'},//prevUnsuccessfulCandidate
                {id: 'prevUnsuccessfulCandidate', x:  width * 0.8, y: height * 0.9, label: 'prevUnsuccessfulCandidate'},

                {id: 'congressRep', x:  width * 0.95, y: height * 0.6, label: 'House'},
                {id: 'prevHouse', x: width * 0.87, y: height * 0.3, label: "previous House"},
                {id: 'congressSen', x:  width * 0.95, y: height * 0.4, label: 'Senate'},
            ];
        }

        // Initialize stages
        let stages = calculateStagePositions();

        // Create tooltip div before using it
        const tooltip = d3.select('#visualization')
            .append('div')
            .attr('class', 'tooltip')
            .style('opacity', 0)
            .style('position', 'absolute')
            .style('background', 'white')
            .style('border', '1px solid #ddd')
            .style('border-radius', '4px')
            .style('padding', '8px')
            .style('pointer-events', 'none')
            .style('box-shadow', '0 2px 4px rgba(0,0,0,0.1)');

        // Process politicians data
        function processCareerStages(politician,congressNum) {
            const careerStages = ['startNode'];
            
            const shouldIncludeStage = (value) => {
                if (value === true || value === "True") return true;
                if (typeof value === "string" && value.trim().length > 0 && value !== "False") return true;
                return false;
            };

            let hasHigherEd = false;

            if (shouldIncludeStage(politician.eliteCollege)) {
                careerStages.push('eliteCollegeBefore');
                careerStages.push('eliteCollege');
                careerStages.push('eliteCollegeAfter');
            } else if (shouldIncludeStage(politician.privateCollege)) {
                careerStages.push('privateCollege');
                careerStages.push('privateCollegeAfter');
            } else if (shouldIncludeStage(politician.publicCollege)) {
                careerStages.push('publicCollege');
            } else {
                careerStages.push('noBA');
            }

            // Community college and no BA can still be included independently
            if (shouldIncludeStage(politician.communityCollege)) careerStages.push('communityCollege');
            // if (shouldIncludeStage(politician.noBA)) careerStages.push('noBA');


            if (shouldIncludeStage(politician.lawSchool)) {
                careerStages.push('lawSchool');
                hasHigherEd = true;
            }
            if (shouldIncludeStage(politician.mba)) {
                careerStages.push('mba');
                hasHigherEd = true;
            }
            if (shouldIncludeStage(politician.otherMasters)) {
                careerStages.push('otherMasters')
                hasHigherEd = true;
            };
            if (shouldIncludeStage(politician.medDegree)) {
                careerStages.push('medDegree')
                hasHigherEd = true;
            };
            if (shouldIncludeStage(politician.doctorate)) {
                careerStages.push('doctorate')
                hasHigherEd = true;
            };

            if (!hasHigherEd) {
                careerStages.push('noHigherEdAfter');
            }

            if (shouldIncludeStage(politician.sports)) careerStages.push('sports');
            if (shouldIncludeStage(politician.military)) careerStages.push('military');
            if (shouldIncludeStage(politician.businessOrManagement)) careerStages.push('businessOrManagement');
            if (shouldIncludeStage(politician.lawyerPrivatePractice) && !shouldIncludeStage(politician.businessOrManagement)) {
                careerStages.push('lawOnlyAfter');
            }
            if (shouldIncludeStage(politician.military) && !shouldIncludeStage(politician.businessOrManagement) && !shouldIncludeStage(politician.lawyerPrivatePractice)) {
                careerStages.push('militaryOnlyAfter');
            }
            if (shouldIncludeStage(politician.lawyerPrivatePractice) && !shouldIncludeStage(politician.military) && shouldIncludeStage(politician.businessOrManagement)) {
                careerStages.push('lawyerPrivatePracticeBusinessNoMilitaryAfter');
            }
            if (!hasHigherEd && !shouldIncludeStage(politician.military) && !shouldIncludeStage(politician.businessOrManagement)) {
                careerStages.push('noGradNoBusinessAfter');
            }
            if (
                hasHigherEd
                && !shouldIncludeStage(politician.businessOrManagement)
                && !shouldIncludeStage(politician.military)
                && !shouldIncludeStage(politician.lawyerPrivatePractice)
            ) careerStages.push("gradNoBusinessAfter");

            if (shouldIncludeStage(politician.media)) careerStages.push('media');
            if (shouldIncludeStage(politician.realEstate)) careerStages.push('realEstate');
            if (shouldIncludeStage(politician.lawyerPrivatePractice)) careerStages.push('lawyerPrivatePractice');
            if (shouldIncludeStage(politician.sciOrEng)) careerStages.push('sciOrEng');
            if (shouldIncludeStage(politician.religion)) careerStages.push('religion');
            if (shouldIncludeStage(politician.blueCollarOrServiceJob)) careerStages.push('blueCollarOrServiceJob');
            if (shouldIncludeStage(politician.healthcare)) careerStages.push('healthcare');
            if (shouldIncludeStage(politician.education)) careerStages.push('education');
            if (shouldIncludeStage(politician.farmingOrRanching)) careerStages.push('farmingOrRanching');

            if (shouldIncludeStage(politician.nonprofitsAndUnions)) careerStages.push('nonprofitsAndUnions');
            if (shouldIncludeStage(politician.publicLawyerOrJudge)) careerStages.push('publicLawyerOrJudge');
            if (shouldIncludeStage(politician.nonElectedGovJob)) careerStages.push('nonElectedGovJob');
            if (shouldIncludeStage(politician.stateLeg)) {
                careerStages.push('stateLegBefore');
                careerStages.push('stateLeg');
                careerStages.push('stateLegAfter');
            }
            if (shouldIncludeStage(politician.localGov)) careerStages.push('localGov');
            if (shouldIncludeStage(politician.prevUnsuccessfulCandidate)) careerStages.push('prevUnsuccessfulCandidate');

            const congressJob = politician.jobs[congressNum];
                if (congressJob === "Senator") {
                    for (let i = 0; i < congressNum; i++) {
                        if (politician.jobs[i] === "Representative") {
                            careerStages.push("prevHouse");
                            break;
                        }
                    }
                    careerStages.push("congressSen");
                } else if (congressJob === "Representative") {
                    careerStages.push("congressRep");
                }

            return {
                id: politician.id,
                name: `${politician.givenName} ${politician.familyName}`,
                stages: careerStages,
                color: politician.parties[congressNum] === 'D' ? '#268AB9' :
                politician.parties[congressNum] === 'R' ? '#FF3C51' : 
                    '#808080',
                party: politician.parties[congressNum],
                state: politician.state,
            };
        }

        function updateVisualization(congressNum) {
            // Clear existing viz
            svg.selectAll('*').remove();

            d3.json("../data/processed-bios.json")
                .then(data => {
                    const activePoliticians = Object.values(data).filter(p => p.jobs[congressNum] !== null);
                    const allPoliticians = activePoliticians.map(p => processCareerStages(p, congressNum));
                    sampledPoliticians = allPoliticians;
                    //.sort(() => 0.5 - Math.random());
                    //.slice(0, 500);

                    const nodeTraffic = new Map(stages.map(stage => [
                        stage.id,
                        { count: 0, pathIndices: [], stageId: stage.id }
                    ]));


                    sampledPoliticians.forEach((politician, pathIndex) => {
                        politician.stages.forEach(stageId => {
                            const traffic = nodeTraffic.get(stageId);
                            if (traffic) {
                                traffic.count++;
                                traffic.pathIndices.push(pathIndex);
                            }
                        });
                    });

                    drawPaths();
                    drawNodes();

                    function drawNodes() {
                    const topHeight1 = height * 0.03;  // Higher top row
                    const topHeight2 = height * 0.07;  // Lower top row
                    const bottomHeight1 = height * 0.93;  // Higher bottom row
                    const bottomHeight2 = height * 0.97;  // Lower bottom row
                    const midHeight = height * 0.5;

                    // Draw circles for nodes
                    svg.selectAll('circle')
                        .data(stages.filter(d => !['startNode', 'congressRep', 'congressSen'].includes(d.id) && !d.id.includes('Before') && 
                        !d.id.includes('After')))
                        .enter()
                        .append('circle')
                        .attr('class', 'node')
                        .attr('cx', d => d.x)
                        .attr('cy', d => d.y)
                        .attr('r', d => {
                            const traffic = nodeTraffic.get(d.id)?.count || 0;
                            return traffic / 8;
                        })
                        .style('fill', 'none')
                        .style('stroke', '#000')
                        .style('stroke-width', 1)
                        .on('mouseover', handleNodeMouseOver)
                        .on('mouseout', handleNodeMouseOut);

                    // Sort stages by x-position within their top/bottom groups
                    const filteredStages = stages.filter(d => !['startNode'].includes(d.id) && 
                                                !d.id.includes('Before') && 
                                                !d.id.includes('After'));
                    const topStages = filteredStages.filter(d => d.y < midHeight).sort((a, b) => a.x - b.x);
                    const bottomStages = filteredStages.filter(d => d.y >= midHeight).sort((a, b) => a.x - b.x);

                    // Function to determine label height
                    const getLabelHeight = (d, index, isTop) => {
                        if (isTop) {
                            return index % 2 === 0 ? topHeight1 : topHeight2;
                        } else {
                            return index % 2 === 0 ? bottomHeight1 : bottomHeight2;
                        }
                    };

                    // Add connecting dotted lines
                    svg.selectAll('.label-line-top')
                        .data(topStages)
                        .enter()
                        .append('line')
                        .attr('class', 'label-line')
                        .attr('x1', d => d.x)
                        .attr('y1', d => d.y)
                        .attr('x2', d => d.x)
                        .attr('y2', (d, i) => getLabelHeight(d, i, true))
                        .style('stroke', '#666')
                        .style('stroke-width', 1)
                        .style('stroke-dasharray', '3,3');

                    svg.selectAll('.label-line-bottom')
                        .data(bottomStages)
                        .enter()
                        .append('line')
                        .attr('class', 'label-line')
                        .attr('x1', d => d.x)
                        .attr('y1', d => d.y)
                        .attr('x2', d => d.x)
                        .attr('y2', (d, i) => getLabelHeight(d, i, false))
                        .style('stroke', '#666')
                        .style('stroke-width', 1)
                        .style('stroke-dasharray', '3,3');

                    // Add labels for top nodes
                    svg.selectAll('.node-label-top')
                        .data(topStages)
                        .enter()
                        .append('text')
                        .attr('class', 'node-label')
                        .attr('x', d => d.x)
                        .attr('y', (d, i) => getLabelHeight(d, i, true))
                        .attr('text-anchor', 'middle')
                        .attr('dominant-baseline', 'baseline')
                        .text(d => d.label);

                    // Add labels for bottom nodes
                    svg.selectAll('.node-label-bottom')
                        .data(bottomStages)
                        .enter()
                        .append('text')
                        .attr('class', 'node-label')
                        .attr('x', d => d.x)
                        .attr('y', (d, i) => getLabelHeight(d, i, false))
                        .attr('text-anchor', 'middle')
                        .attr('dominant-baseline', 'hanging')
                        .text(d => d.label);
                };

                function drawPaths() {
                    const line = d3.line()
                        .x(d => d.x)
                        .y(d => d.y)
                        .curve(d3.curveCatmullRom.alpha(0.5));

                    sampledPoliticians.forEach((politician, pathIndex) => {
                        const pathPoints = politician.stages
                            .map(stageId => {
                                const stage = stages.find(s => s.id === stageId);
                                if (!stage) return null;
                                const traffic = nodeTraffic.get(stageId);
                                const offset = traffic ? calculateOffset(traffic, pathIndex) : 0;
                                return { x: stage.x, y: stage.y + offset };
                            })
                            .filter(point => point !== null)
                            .sort((a, b) => a.x - b.x);

                        svg.append('path')
                            .attr('class', 'path')
                            .datum(politician)
                            .attr('d', line(pathPoints))
                            .style('stroke', politician.color)
                            .style('opacity', 0.6)
                            .style('stroke-width', '1.25px')
                            .on('mouseover', (event) => handlePathMouseOver(event, politician))
                            .on('mouseout', handlePathMouseOut);
                    });
                }

                })
                .catch(error => {
                    console.error('Error loading the JSON file:', error);
                });
        }

        congressSelect.addEventListener('change', (event) => {
            updateVisualization(parseInt(event.target.value));
        });

        updateVisualization(118);


        // Event handlers
        function handleNodeMouseOver(event, d) {
            const traffic = nodeTraffic.get(d.id);
            svg.selectAll('.path')
                .style('opacity', pathElement => {
                    const politician = d3.select(pathElement).datum();
                    return politician.stages.includes(d.id) ? 1 : 0.1;
                    // const pathIndex = sampledPoliticians.indexOf(path);
                    // return traffic.pathIndices.includes(pathIndex) ? '3px' : '1.5px';
                })
                .style('stroke-width', pathElement => {
                    const politician = d3.select(pathElement).datum();
                    return politician.stages.includes(d.id) ? '3px' : '1.5px';
                });
            tooltip.transition()
                .duration(200)
                .style('opacity', 0.9);
            tooltip.html(`
                <strong>${d.label}</strong><br/>
                Paths: ${traffic ? traffic.count : 0}
            `)
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 28) + 'px');
        }

        function handleNodeMouseOut() {
            svg.selectAll('.path')
                .style('opacity',0.6)
                .style('stroke-width','1.5px');

            tooltip.transition()
                .duration(500)
                .style('opacity', 0);
        }

        // Modify the handlePathMouseOver function:
        function handlePathMouseOver(event, politician) {
            // Dim all paths
            svg.selectAll('.path')
                .style('opacity', 0.05)
                .style('stroke-width', '1.5px');

            // Highlight selected path
            d3.select(event.target)
                .style('opacity', 1)
                .style('stroke-width', '3px');

            // Dim all nodes and labels
            svg.selectAll('.node')
                .style('opacity', 0.1);
            svg.selectAll('.node-label')
                .style('opacity', 0.1);
            svg.selectAll('.label-line')
                .style('opacity', 0.1);

            // Highlight relevant nodes and labels
            politician.stages.forEach(stageId => {
                const stage = stages.find(s => s.id === stageId);
                if (stage) {
                    svg.selectAll('.node')
                        .filter(d => d.id === stageId)
                        .style('opacity', 1);
                    svg.selectAll('.node-label')
                        .filter(d => d.id === stageId)
                        .style('opacity', 1);
                    svg.selectAll('.label-line')
                        .filter(d => d.id === stageId)
                        .style('opacity', 1);
                }
            });

            tooltip.transition()
                .duration(200)
                .style('opacity', 0.9);
            tooltip.html(`
                <strong>${politician.name}</strong><br/>
                ${politician.party} - ${politician.state}
            `)
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 28) + 'px')
                .style('color', politician.color);
        }

        // Modify the handlePathMouseOut function:
        function handlePathMouseOut(event) {
            // Restore all paths, nodes, and labels
            svg.selectAll('.path')
                .style('opacity', 0.6)
                .style('stroke-width', '1.5px');
            svg.selectAll('.node')
                .style('opacity', 1);
            svg.selectAll('.node-label')
                .style('opacity', 1);
            svg.selectAll('.label-line')
                .style('opacity', 1);
            
            tooltip.transition()
                .duration(500)
                .style('opacity', 0);
        }

        function calculateOffset(traffic, pathIndex) {
            // Skip offset calculation for certain nodes
            if (['startNode', 'congressRep', 'congressSen'].includes(traffic.stageId)) {
                return 0;
            }

            const politician = sampledPoliticians[pathIndex];
            const spread = 0.35;  // Spread between paths within same party
            
            // Separate paths by party
            const democratPaths = traffic.pathIndices.filter(i => sampledPoliticians[i].party === 'D');
            const republicanPaths = traffic.pathIndices.filter(i => sampledPoliticians[i].party === 'R');
            const otherPaths = traffic.pathIndices.filter(i => !['D', 'R'].includes(sampledPoliticians[i].party));
            
            // Calculate base separation based on number of paths
            const totalPaths = traffic.pathIndices.length;
            const baseSeparation = 0.16 * (0.5 * democratPaths.length + 0.5 * republicanPaths.length); // SPREAD BTWN PARTIES
            // Scales with paths but capped between 10 and 30
            
            // Calculate position within party group
            const partyPaths = politician.party === 'D' ? democratPaths : 
                            politician.party === 'R' ? republicanPaths : 
                            otherPaths;
            
            const partyPosition = partyPaths.indexOf(pathIndex);
            const totalWidth = (partyPaths.length - 1) * spread;
            
            // Calculate base offset by party
            let baseOffset = 0;
            if (politician.party === 'D') {
                baseOffset = -baseSeparation;
            } else if (politician.party === 'R') {
                baseOffset = baseSeparation;
            }
            
            // Add spread within party group
            return baseOffset + ((partyPosition * spread) - (totalWidth / 2));
        }


    </script>
</body>
</html>